<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Range Trainer ‚Äî Compact Top (Final)</title>
<style>
  :root{
    --bg:#0b0f14; --panel2:#101827; --border:#223047; --text:#e7ecf3;
    --FOLD:#f4f6fa; --L-F-F:#a7e8a7; --L-C-F:#155d15; --L-C-AI:#bcdcf3; --L-R-AI:#0b3a94;
    --MR-F-F:#ffe27a; --MR-C-AI:#7b4a2a; --MR-4B-AI:#e44747; --SHOVE:#6d4b8e;
    --ok:#1f9d55; --err:#d64545;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.35 -apple-system,system-ui,Segoe UI,Roboto,Arial;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    -webkit-user-select:none;user-select:none;
  }

  /* --- –¢–æ–ø –±–∞—Ä: –æ—Å—Ç–∞–≤–µ–Ω –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å --- */
  .top{
    position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;
    padding:6px 8px;background:var(--panel2);border-bottom:1px solid var(--border)
  }
  .chip{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0f1624;font-size:12px;display:inline-flex;gap:6px;align-items:center}
  .chip b{min-width:2.2ch;text-align:center;font-variant-numeric:tabular-nums}
  .btn{border:1px solid var(--border);background:#0f1624;color:var(--text);border-radius:10px;
       padding:8px 10px;font-weight:800;cursor:pointer;line-height:1}

  /* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: –º–∏–Ω–∏–º–∞–ª–Ω–∏ –æ—Ç—Å—Ç–æ—è–Ω–∏—è, –±–µ–∑ –∏–∑–ª–∏—à–Ω–∏ —Ä–∞–º–∫–∏ --- */
  .wrap{max-width:900px;margin:0 auto;padding:6px 8px 8px}

  /* --- –ì–ª–∞–≤–Ω–∞ –∫–∞—Ä—Ç–∞ (–±–µ–∑ —Ç–µ–∂–∫–∏ —Å–µ–Ω–∫–∏) --- */
  .card{border:1px solid var(--border);background:#0f1624;border-radius:10px;padding:8px}

  /* --- –•–µ–¥—ä—Ä: –ø–æ–∑–∏—Ü–∏—è/—Å—Ç–∞–∫/—Ä—ä–∫–∞ + –∫–∞—Ä—Ç–∏ PNG (—Å–∞–º–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏) --- */
  .head{display:grid;grid-template-columns:auto 1fr;gap:6px;align-items:center}
  .meta{display:flex;flex-wrap:wrap;gap:6px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#0f1624;
         border-radius:999px;padding:5px 9px;font-weight:800}
  .handBig{font-size:22px;font-weight:1000;letter-spacing:.2px}

  .cards{display:flex;gap:6px;align-items:center}
  .cardImg{width:48px;height:66px;border-radius:8px;display:block}
  /* –ª–µ–∫–∞ –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–æ–≤–∞ —Ä—ä–∫–∞ */
  .deal .cardImg{transform:translateY(8px);opacity:0}
  .deal .cardImg.show{transform:translateY(0);opacity:1;transition:transform .2s cubic-bezier(.2,.8,.2,1),opacity .2s linear}

  /* --- –î–µ–π—Å—Ç–≤–∏—è (–µ–¥–∏–Ω —Ä–µ–¥; wrap —Å–∞–º–æ –ø—Ä–∏ –Ω—É–∂–¥–∞) --- */
  .actions{margin-top:6px}
  .actionsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(104px,1fr));gap:6px}
  .actBtn{
    border:1px solid rgba(0,0,0,.18);border-radius:8px;padding:9px 8px;
    font-size:13px;font-weight:1000;letter-spacing:.2px;text-align:center;color:#000;background:#bbb
  }
  .actBtn.ok{box-shadow:0 0 0 3px rgba(31,157,85,.45) inset}
  .actBtn.err{box-shadow:0 0 0 3px rgba(214,69,69,.45) inset}
  .actBtn .lbl{line-height:1.05}
  .tag{position:absolute;right:6px;top:4px;font-size:10px;opacity:.7;color:#000}

  /* --- Keypad (–∑–∞ PUSH) ‚Äî —Å—É–ø–µ—Ä –∫–æ–º–ø–∞–∫—Ç–µ–Ω --- */
  .disp{margin:4px 0 6px;border:1px solid var(--border);background:#0b1220;border-radius:8px;padding:8px;font-weight:900;text-align:center}
  .disp.ok{border-color:var(--ok)} .disp.err{border-color:var(--err)}
  .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
  .key{border:1px solid var(--border);background:#111a2b;border-radius:8px;padding:12px 0;font-weight:900;font-size:18px}

  /* --- Feedback –±–ª–∏–∑–æ –¥–æ –±—É—Ç–æ–Ω–∏—Ç–µ --- */
  .feedback{margin-top:6px;font-weight:900}
  .ok{color:var(--ok)} .err{color:var(--err)}

  /* --- ‚Äû–ü—Ä–∞–≤–∏–ª–µ–Ω:‚Äú —Ä–µ–¥ ‚Äî –ö–õ–ò–ö–í–ê–ï–ú, pointer + –ª–µ–∫ –µ—Ñ–µ–∫—Ç --- */
  .resRow{
    margin-top:6px;padding:6px 8px;border:1px dashed #2a3b58;border-radius:8px;
    display:flex;justify-content:space-between;align-items:center;gap:6px;
    cursor:pointer; transition:background .18s, filter .12s;
  }
  .resRow:hover{background:#223047}
  .resRow:active{filter:brightness(1.06)}
  .val{font-weight:900;padding:5px 8px;border-radius:8px;min-width:88px;text-align:center}

  /* --- –ñ–û–ö–ï–†: —Ü–µ–Ω—Ç—Ä–∏—Ä–∞–Ω --- */
  #jokerPanel{display:none;margin-top:6px;border:1px dashed var(--border);border-radius:8px;padding:8px;background:#0f1624}
  #jokerHead{display:flex;justify-content:space-between;align-items:center;gap:6px;margin-bottom:6px}
  #jokerModeName{font-size:12px;opacity:.85}
  .jokerWrap{display:flex;justify-content:center}
  .jokerGrid{display:grid;grid-template-columns:repeat(13, max-content);gap:1px}
  .jk{
    width:22px;height:22px;display:flex;align-items:center;justify-content:center;
    font-weight:800;border:1px solid #222;font-size:10px;line-height:1
  }
  .jk.cur{outline:2px solid #4da3ff;outline-offset:-1px}

  /* --- –ö–æ–Ω—Ç—Ä–æ–ª–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω–∏) + –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É—Ç–æ–Ω --- */
  .underbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .underbar .btn{flex:1}

  /* --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∫—Ä–∏—Ç–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ) --- */
  .settings{display:none;margin-top:6px;border:1px solid var(--border);background:#0f1624;border-radius:8px;padding:8px}
  .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
  .mini{font-size:12px;opacity:.8}
  .badgeOpt{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#0f1624;border-radius:999px;padding:5px 9px;font-weight:800}
  .badgeOpt input{accent-color:#4da3ff}

  /* --- Shake –ø—Ä–∏ –≥—Ä–µ—à–∫–∞ --- */
  @keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}
  .shaking{animation:shake .22s ease}
  @media (prefers-reduced-motion: reduce){
    .deal .cardImg,.deal .cardImg.show{transition:none}
    .shaking{animation:none}
  }
</style>
</head>
<body>
<!-- Top bar -->
<div class="top">
  <div style="display:flex;gap:6px;align-items:center">
    <span class="chip">Q: <b id="qCount">0</b></span>
    <span class="chip">‚úî: <b id="qRight">0</b></span>
    <span class="chip">üî•: <b id="streak">0</b></span>
  </div>
  <button class="btn" id="btnEdit">–†–µ–¥–∞–∫—Ç–æ—Ä</button>
</div>

<div class="wrap">
  <div class="card" id="mainCard">
    <!-- Header: –≤—Å–∏—á–∫–æ –Ω–∞–π-–æ—Ç–≥–æ—Ä–µ -->
    <div class="head">
      <div class="meta">
        <span class="badge" id="qPos">–ü–æ–∑–∏—Ü–∏—è: ‚Äî</span>
        <span class="badge" id="qStack">–°—Ç–∞–∫: ‚Äî</span>
        <span class="badge handBig" id="qHand">‚Äî</span>
      </div>
      <div class="cards" id="meCards"></div>
    </div>

    <!-- Actions -->
    <div class="actions"><div id="ansArea"></div></div>

    <!-- Feedback -->
    <div id="feedback" class="feedback"></div>

    <!-- –ü—Ä–∞–≤–∏–ª–µ–Ω (–∫–ª–∏–∫–∞–µ–º) -->
    <div id="correctRow" class="resRow" style="display:none" role="button" tabindex="0" title="–ù–∞—Ç–∏—Å–Ω–∏ –∑–∞ —Å–ª–µ–¥–≤–∞—â–∞ —Ä—ä–∫–∞">
      <div>–ü—Ä–∞–≤–∏–ª–µ–Ω:</div><div id="correctVal" class="val">‚Äî</div>
    </div>

    <!-- Joker (—Ü–µ–Ω—Ç—Ä–∏—Ä–∞–Ω) -->
    <div id="jokerPanel">
      <div id="jokerHead">
        <button id="btnJokerMode" class="btn" style="padding:6px 10px;font-size:13px">–°–º–µ–Ω–∏ –∂–æ–∫–µ—Ä</button>
        <span id="jokerModeName" class="mini"></span>
      </div>
      <div class="jokerWrap"><div id="jokerContent"></div></div>
    </div>

    <!-- Controls + Settings toggle -->
    <div class="underbar">
      <button id="btnStart" class="btn">–°—Ç–∞—Ä—Ç</button>
      <button id="btnCheck" class="btn">–ü—Ä–æ–≤–µ—Ä–∏</button>
      <button id="btnNext" class="btn">–°–ª–µ–¥–≤–∞—â</button>
      <button id="btnResetScore" class="btn">–ù—É–ª–∏—Ä–∞–π</button>
      <button id="toggleSettings" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </div>

  <!-- Settings (—Å–∫—Ä–∏—Ç–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ) -->
  <div class="settings" id="settingsCard">
    <div class="mini">–ü–æ–∑–∏—Ü–∏–∏ –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</div>
    <div id="posFilters" class="row"></div>
    <div class="mini">–°—Ç–∞–∫ –¥–∏–∞–ø–∞–∑–æ–Ω–∏:</div>
    <div id="stkFilters" class="row"></div>
  </div>
</div>

<!-- EDITOR -->
<div id="editModal" class="overlay" style="display:none;align-items:center;justify-content:center;padding:12px;background:rgba(0,0,0,.6);z-index:60">
  <div class="box" style="width:100%;max-width:720px;background:#0f1520;border:1px solid var(--border);border-radius:10px;overflow:hidden">
    <div class="boxHead" style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#101827;border-bottom:1px solid var(--border)">
      <div><b>–†–µ–¥–∞–∫—Ç–æ—Ä</b> <span id="editMeta" class="mini"></span></div>
      <button id="editClose" class="btn">X</button>
    </div>
    <div class="boxBody" style="padding:8px 10px">
      <div class="row">
        <select id="editPos" class="btn" style="flex:1"></select>
        <select id="editStk" class="btn" style="flex:1"></select>
      </div>
      <div class="mini" style="margin:6px 0">–§–æ—Ä–º–∞—Ç: <code>HAND = ACTION</code> / <code>default = ACTION</code>; –∑–∞ PUSH ‚Äî —á–∏—Å–ª–æ.</div>
      <textarea id="editArea" style="width:100%;min-height:220px;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px;font:14px/1.35 ui-monospace" placeholder="AJo = L-C-AI&#10;default = Fold"></textarea>
    </div>
    <div class="boxFoot" style="display:flex;gap:6px;justify-content:space-between;padding:8px 10px;border-top:1px solid var(--border);background:#0f1520">
      <button id="editClear" class="btn">–ò–∑—á–∏—Å—Ç–∏ —Ç–∞–∑–∏ –∫–ª–µ—Ç–∫–∞</button>
      <div><button id="editSave" class="btn">–ó–∞–ø–∞–∑–∏</button></div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ================= Base ================= */
  const COLORS={"FOLD":"#f4f6fa","L-F-F":"#a7e8a7","L-C-F":"#155d15","L-C-AI":"#bcdcf3","L-R-AI":"#0b3a94","MR-F-F":"#ffe27a","MR-C-AI":"#7b4a2a","MR-4B-AI":"#e44747","SHOVE":"#6d4b8e"};
  const norm=s=>(s||"").toUpperCase().replace(/\s+/g,"");

  // ‚ûú –ù–æ–≤–∞—Ç–∞ –ª–æ–≥–∏–∫–∞: —á–∏—Å–ª–æ–≤ —Ä–µ–∂–∏–º –∞–∫–æ:
  // 1) –ø–æ–∑–∏—Ü–∏—è—Ç–∞ —Å—ä–¥—ä—Ä–∂–∞ PUSH –≤ –∏–º–µ—Ç–æ (–∫–∞–∫—Ç–æ –¥–æ—Å–µ–≥–∞), –∏–ª–∏
  // 2) –µ SBvsBB –ò —Å—Ç–∞–∫—ä—Ç –µ 0‚Äì4
  const isPushPos=(pos, stk)=> (pos==="SBvsBB" && stk==="0‚Äì4") || /PUSH/i.test(pos);

  const alias=(key,act)=>{const up=(act||"").toUpperCase();
    if(!(key==="BBvsSB_L"||key==="HUBB_L"||key==="HUBB_MR"||key==="BBvsBU_MR"||key==="SBvsBU_MR"||key==="BBvsSB_MR"))return{d:act,c:null};
    if(up==="MR-F-F")return{d:"Check/Call",c:COLORS["MR-F-F"]};
    if(up==="L-C-AI")return{d:"ISO/3bet",c:COLORS["L-C-AI"]};
    if(up==="SHOVE")return{d:"ISO/3bet AI",c:COLORS["SHOVE"]};
    if(up==="MR-4B-AI")return{d:"ISO/3bet/Fold",c:COLORS["MR-4B-AI"]};
    return{d:act,c:null};};
  const resolveDisplay=(key,act)=>{const a=alias(key,act);return{ text:a.d, color:a.c||COLORS[norm(act)]||"" }};

  const POS_LIST=["HUSB","BU","HUBB_L","HUBB_MR","HUBBv_PUSH","SBvsBU","SBvsBU_PUSH","SBvsBB","BBvsBU_MR","BBvsBU_PUSH","BBvsSB_L","BBvsSB_MR","BBvsSB_PUSH"];
  const STKS=["0‚Äì4","4‚Äì7","7‚Äì10","10‚Äì13","13+"];

  const HANDS=`AA KK QQ JJ TT 99 88 77 66 55 44 33 22
AKs AKo AQs AQo AJs AJo ATs ATo A9s A9o A8s A8o A7s A7o A6s A6o A5s A5o A4s A4o A3s A3o A2s A2o
KQs KQo KJs KJo KTs KTo K9s K9o K8s K8o K7s K7o K6s K6o K5s K5o K4s K4o K3s K3o K2s K2o
QJs QJo QTs QTo Q9s Q9o Q8s Q8o Q7s Q7o Q6s Q6o Q5s Q5o Q4s Q4o Q3s Q3o Q2s Q2o
JTs JTo J9s J9o J8s J8o J7s J7o J6s J6o J5s J5o J4s J4o J3s J3o J2s J2o
T9s T9o T8s T8o T7s T7o T6s T6o T5s T5o T4s T4o T3s T3o T2s T2o
98s 98o 97s 97o 96s 96o 95s 95o 94s 94o 93s 93o 92s 92o
87s 87o 86s 86o 85s 85o 84s 84o 83s 83o 82s 82o
76s 76o 75s 75o 74s 74o 73s 73o 72s 72o
65s 65o 64s 64o 63s 63o 62s 62o
54s 54o 53s 53o 52s 52o
43s 43o 42s 42o 32s 32o`.trim().split(/\s+/);

  /* ================= DB ================= */
  let DB=JSON.parse(localStorage.getItem("qt_trainer_v7")||"{}");
  const save=()=>localStorage.setItem("qt_trainer_v7",JSON.stringify(DB));
  const k=(p,r)=>p+"||"+r, get=(p,r)=>DB[k(p,r)]?.raw||"", set=(p,r,raw)=>{DB[k(p,r)]={raw};save();};

  /* ================= State ================= */
  let curQ=null, count=0, right=0, streak=0;
  let numBuf=""; let lastPressedBtn=null;
  const mainCard=document.getElementById("mainCard");

  /* ================= –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –≥—Ä–µ—à–∫–∞ ================= */
  const vibrateShort=()=>{ if(navigator && typeof navigator.vibrate==="function"){ try{ navigator.vibrate(150);}catch(_e){} } };

  /* ================= Cards as PNG (Canvas -> Base64) ================= */
  const CARD_CACHE={};
  function pngForCard(rank,suit){
    const key=rank+suit; if(CARD_CACHE[key]) return CARD_CACHE[key];
    const W=220,H=308,R=24,can=document.createElement('canvas'); can.width=W; can.height=H; const ctx=can.getContext('2d');
    const grad=ctx.createLinearGradient(0,0,0,H); grad.addColorStop(0,'#fff'); grad.addColorStop(1,'#eaeef6');
    roundRect(ctx,4,4,W-8,H-8,R); ctx.fillStyle=grad; ctx.fill();
    ctx.strokeStyle='#c7cfdc'; ctx.lineWidth=4; roundRect(ctx,6,6,W-12,H-12,R-4); ctx.stroke();
    const red=(suit==='‚ô•'||suit==='‚ô¶'); ctx.fillStyle=red?'#c53030':'#111';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font='bold 150px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.fillText(rank, W/2, H/2-14);
    ctx.font='bold 90px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.fillText(suit, W/2+58, H/2+68);
    ctx.font='bold 54px system-ui,-apple-system,Segoe UI,Roboto,Arial'; ctx.textAlign='left'; ctx.textBaseline='top';
    ctx.fillText(rank,22,20); ctx.fillText(suit,22,70);
    const data=can.toDataURL('image/png'); CARD_CACHE[key]=data; return data;
    function roundRect(c,x,y,w,h,r){c.beginPath();c.moveTo(x+r,y);c.arcTo(x+w,y,x+w,y+h,r);c.arcTo(x+w,y+h,x,y+h,r);c.arcTo(x,y+h,x,y,r);c.arcTo(x,y,x+w,y,r);c.closePath();}
  }
  function parseHand(h){const m=/^([AKQJT98765432])([AKQJT98765432])([so])?$/i.exec(h); if(!m)return null; const r1=m[1].toUpperCase(),r2=m[2].toUpperCase(),so=(m[3]||"").toLowerCase(); return {r1,r2,pair:r1===r2,suited:so==="s",off:so==="o"};}
  function renderHeroPNG(hand){
    const box=document.getElementById("meCards"); box.innerHTML="";
    const p=parseHand(hand);
    function imgEl(rank,suit){const img=new Image(); img.className='cardImg'; img.src=pngForCard(rank,suit); img.alt=rank+suit; return img;}
    if(!p){ box.appendChild(imgEl('A','‚ô•')); box.appendChild(imgEl('K','‚ô†')); return; }
    if(p.pair){ box.appendChild(imgEl(p.r1,'‚ô•')); box.appendChild(imgEl(p.r2,'‚ô†')); }
    else if(p.suited){ box.appendChild(imgEl(p.r1,'‚ô•')); box.appendChild(imgEl(p.r2,'‚ô•')); }
    else { box.appendChild(imgEl(p.r1,'‚ô•')); box.appendChild(imgEl(p.r2,'‚ô£')); }
  }
  function animateHeroCards(){
    const el=document.getElementById("meCards"); el.classList.remove("deal"); void el.offsetHeight; el.classList.add("deal");
    [...el.querySelectorAll(".cardImg")].forEach((c,i)=>{ c.classList.remove("show"); setTimeout(()=>c.classList.add("show"), i*50); });
  }

  /* ================= Filters / Settings ================= */
  const POS_EL=document.getElementById("posFilters"); const STK_EL=document.getElementById("stkFilters");
  function buildFilters(){
    POS_EL.innerHTML=""; POS_LIST.forEach(p=>{const lab=document.createElement("label"); lab.className="badgeOpt";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=true; cb.dataset.pos=p;
      lab.appendChild(cb); lab.append(" "+p); POS_EL.appendChild(lab);});
    STK_EL.innerHTML=""; STKS.forEach(s=>{const lab=document.createElement("label"); lab.className="badgeOpt";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=true; cb.dataset.stk=s;
      lab.appendChild(cb); lab.append(" "+s); STK_EL.appendChild(lab);});
  }
  function getFilters(){
    const posSel=[...document.querySelectorAll('#posFilters input:checked')].map(x=>x.dataset.pos);
    const stkSel=[...document.querySelectorAll('#stkFilters input:checked')].map(x=>x.dataset.stk);
    return { pos: posSel.length?posSel:POS_LIST.slice(), stk: stkSel.length?stkSel:STKS.slice() };
  }
  buildFilters();

  /* ================= Compute / Evaluate ================= */
  function compute(pos,hand,stk){
    const raw=get(pos,stk); if(!raw) return {disp:"‚Äî", isNum:isPushPos(pos, stk)};
    const lines=raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    let map={},def=null;
    lines.forEach(l=>{const [h,v]=l.split("=").map(x=>x.trim()); if(v==null){def=h;} else if(/^default$/i.test(h)) def=v; else map[h.toUpperCase()]=v;});
    const disp=map[hand.toUpperCase()]||def||"‚Äî";
    return {disp, isNum:isPushPos(pos, stk)};
  }

  /* ================= Joker (—Ü–µ–Ω—Ç—Ä–∏—Ä–∞–Ω) ================= */
  let jokerMode=localStorage.getItem("jokerMode")||"table";
  const jokerPanel=document.getElementById("jokerPanel");
  const jokerContent=document.getElementById("jokerContent");
  const jokerModeName=document.getElementById("jokerModeName");
  document.getElementById("btnJokerMode").onclick=()=>{jokerMode = (jokerMode==="table")?"flash":"table"; localStorage.setItem("jokerMode",jokerMode); jokerModeName.textContent=labelForMode(jokerMode); renderJoker();};
  function labelForMode(m){return m==="table"?"–ñ–æ–∫–µ—Ä: –¢–∞–±–ª–∏—Ü–∞ 13√ó13":"–ñ–æ–∫–µ—Ä: Flash Cards";}
  function renderJoker(){
    if(!curQ){ jokerPanel.style.display="none"; return; }
    jokerPanel.style.display="block"; jokerModeName.textContent=labelForMode(jokerMode); jokerContent.innerHTML="";
    if(jokerMode==="table"){
      const grid=document.createElement("div"); grid.className="jokerGrid";
      const ranks=["A","K","Q","J","T","9","8","7","6","5","4","3","2"];
      for(let i=0;i<13;i++){ for(let j=0;j<13;j++){
        let h; if(i===j) h=ranks[i]+ranks[j]; else if(i<j) h=ranks[i]+ranks[j]+"s"; else h=ranks[j]+ranks[i]+"o";
        const r=compute(curQ.pos, h.toUpperCase(), curQ.stk);
        const cell=document.createElement("div"); cell.className="jk";
        if(r.isNum){ cell.textContent=(r.disp==="‚Äî")?"":r.disp; cell.style.background="#1a2335"; cell.style.color="#fff"; }
        else{ const dd=resolveDisplay(curQ.pos,r.disp); cell.textContent=h; cell.style.background=dd.color||"#2a2f3c"; cell.style.color="#000"; }
        if(h.toUpperCase()===curQ.hand.toUpperCase()) cell.classList.add("cur");
        grid.appendChild(cell);
      }} jokerContent.appendChild(grid);
    }else{
      const wrap=document.createElement("div"); wrap.style.display="flex"; wrap.style.flexWrap="wrap"; wrap.style.gap="6px"; wrap.style.justifyContent="center";
      const curRes=compute(curQ.pos,curQ.hand.toUpperCase(),curQ.stk); const target=curRes.disp; const isNum=curRes.isNum;
      const ph=h=>{const m=/^([AKQJT98765432])([AKQJT98765432])([so])?$/i.exec(h); if(!m)return null; const r1=m[1].toUpperCase(),r2=m[2].toUpperCase(),so=(m[3]||"").toLowerCase(); return {r1,r2,pair:r1===r2,suited:so==="s",off:so==="o"};}
      const base=ph(curQ.hand);
      const sim=h=>{const p=ph(h); if(!p||!base)return false; if(base.pair)return p.pair; if(base.suited)return p.suited&&p.r1===base.r1; if(base.off)return p.off&&p.r1===base.r1; return p.r1===base.r1&&p.r2===base.r2;}
      for(const h of HANDS){ if(!sim(h))continue; const r=compute(curQ.pos,h.toUpperCase(),curQ.stk); if(r.disp==="‚Äî")continue;
        if((!isNum&&r.disp===target)||(isNum&&Number(r.disp)===Number(target))){
          const dd=resolveDisplay(curQ.pos,r.disp); const chip=document.createElement("div");
          chip.style.border="1px solid rgba(0,0,0,.2)"; chip.style.borderRadius="10px"; chip.style.padding="6px 8px"; chip.style.fontWeight="800";
          chip.style.background=isNum?"#1a2335":(dd.color||"#2a2f3c"); chip.style.color=isNum?"#fff":"#000"; chip.textContent=isNum?`${h} = ${r.disp}`:h;
          wrap.appendChild(chip);
        }
      }
      if(!wrap.childNodes.length){ const none=document.createElement("div"); none.className="mini"; none.style.opacity=".8"; none.textContent="–ù—è–º–∞ –¥—Ä—É–≥–∏ —Å—Ö–æ–¥–Ω–∏ —Ä—ä—Ü–µ —Å—ä—Å —Å—ä—â–æ—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ."; wrap.appendChild(none); }
      jokerContent.appendChild(wrap);
    }
  }

  /* ================= UI / Flow ================= */
  const qPosEl=document.getElementById("qPos"), qStackEl=document.getElementById("qStack"), qHandEl=document.getElementById("qHand");
  function askNew(){
    const sel=getFilters();
    const pos=rand(sel.pos), stk=rand(sel.stk), hand=rand(HANDS);
    curQ={pos,stk,hand}; numBuf=""; lastPressedBtn=null;
    qPosEl.textContent="–ü–æ–∑–∏—Ü–∏—è: "+pos; qStackEl.textContent="–°—Ç–∞–∫: "+stk; qHandEl.textContent=hand;
    document.getElementById("feedback").textContent=""; const cRow=document.getElementById("correctRow"); cRow.style.display="none";
    document.getElementById("jokerPanel").style.display="none";
    renderAnswerUI(); renderHeroPNG(hand); animateHeroCards();
  }
  function renderAnswerUI(){
    const a=document.getElementById("ansArea"); a.innerHTML="";
    if(isPushPos(curQ.pos, curQ.stk)){
      const disp=document.createElement("div"); disp.className="disp"; disp.id="numDisp"; disp.textContent="–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ";
      const grid=document.createElement("div"); grid.className="keypad";
      ["7","8","9","4","5","6","1","2","3",".","0","‚Üê"].forEach(k=>{const b=document.createElement("button"); b.className="key"; b.textContent=k; b.onclick=()=>keyPress(k); grid.appendChild(b);});
      a.appendChild(disp); a.appendChild(grid);
    }else{
      const g=document.createElement("div"); g.className="actionsGrid";
      Object.keys(COLORS).forEach(act=>{
        const b=document.createElement("button"); b.className="actBtn";
        const disp=resolveDisplay(curQ.pos,act); const bg=disp.color||"#bbb";
        b.style.background=`linear-gradient(180deg, ${bg} 0%, ${bg} 72%, rgba(0,0,0,.06) 100%)`;
        const lbl=document.createElement("span"); lbl.className="lbl"; lbl.innerHTML=disp.text.replace(/\//g,'/<br>');
        b.appendChild(lbl);
        const t=document.createElement("span"); t.className="tag"; t.textContent=(disp.text.includes("AI")||act.includes("AI"))?"AI":""; b.appendChild(t);
        b.onclick=()=>{ lastPressedBtn=b; checkAnswer(false,act); };
        g.appendChild(b);
      });
      a.appendChild(g);
    }
  }
  function keyPress(k){
    const d=document.getElementById("numDisp");
    if(k==="‚Üê"){ numBuf=numBuf.slice(0,-1); if(d) d.textContent=numBuf||"–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ"; return; }
    if(k==="." && numBuf.includes(".")) return;
    if(numBuf.length>=6) return;
    numBuf+=k; if(d) d.textContent=numBuf;
  }

  function checkAnswer(showOnly=false, chosenAct=null){
    if(!curQ) return;
    const res=compute(curQ.pos,curQ.hand,curQ.stk);
    const fb=document.getElementById("feedback"), cRow=document.getElementById("correctRow"), cVal=document.getElementById("correctVal");

    if(res.disp==="‚Äî"){
      fb.textContent="–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ —Ç–∞–∑–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è."; fb.className="feedback";
      cRow.style.display="flex"; cVal.textContent="‚Äî"; cVal.style.background="#2a3c55"; cVal.style.color="#fff";
      if(lastPressedBtn){ lastPressedBtn.classList.remove("ok","err"); }
      const d=document.getElementById("numDisp"); if(d){ d.classList.remove("ok","err"); }
      renderJoker(); // –ø–æ–∫–∞–∂–∏ –∂–æ–∫–µ—Ä–∞, –º–∞–∫–∞—Ä –¥–∞ –Ω—è–º–∞ –¥–∞–Ω–Ω–∏
      return;
    }

    if(!showOnly){
      count++; let ok=false;
      if(res.isNum){
        const ans=Number(numBuf), tgt=Number(res.disp); ok=Number.isFinite(ans)&&Math.abs(ans-tgt)<=0.1;
        const d=document.getElementById("numDisp"); if(d){ d.classList.toggle("ok",ok); d.classList.toggle("err",!ok); }
      }else{
        ok = chosenAct!=null && chosenAct===res.disp;
        if(lastPressedBtn){ lastPressedBtn.classList.toggle("ok",ok); lastPressedBtn.classList.toggle("err",!ok); }
      }
      if(ok){ right++; streak++; fb.textContent="–í–Ø–†–ù–û!"; fb.className="feedback ok"; }
      else { streak=0; fb.textContent="–ì–†–ï–®–ù–û"; fb.className="feedback err"; vibrateShort(); mainCard.classList.add("shaking"); setTimeout(()=>mainCard.classList.remove("shaking"), 240); }
      document.getElementById("qCount").textContent=count; document.getElementById("qRight").textContent=right; document.getElementById("streak").textContent=streak;
    }

    // –ü–æ–∫–∞–∂–∏ ‚Äû–ü—Ä–∞–≤–∏–ª–µ–Ω:‚Äú –∏ –Ω–∞–ø—Ä–∞–≤–∏ –¶–ï–õ–ò–Ø –†–ï–î –ö–õ–ò–ö–í–ê–ï–ú (–¥–∏—Ä–µ–∫—Ç–Ω–æ –Ω–æ–≤–∞ —Ä—ä–∫–∞)
    cRow.style.display="flex";
    const dispRight=resolveDisplay(curQ.pos,res.disp);
    cVal.textContent=res.isNum?res.disp:dispRight.text;
    if(res.isNum){ cVal.style.background="rgba(0,0,0,.22)"; cVal.style.color="#fff"; }
    else { cVal.style.background=dispRight.color||"#2a2f3c"; cVal.style.color="#000"; }

    const goNext=()=>askNew();
    cRow.onclick=goNext;
    cRow.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); goNext(); } };

    renderJoker();
  }

  /* ================= Editor ================= */
  const editModal=document.getElementById("editModal"), editPos=document.getElementById("editPos"), editStk=document.getElementById("editStk"), editArea=document.getElementById("editArea");
  document.getElementById("btnEdit").onclick=()=>{ editPos.innerHTML=POS_LIST.map(p=>`<option value="${p}">${p}</option>`).join(""); editStk.innerHTML=STKS.map(s=>`<option value="${s}">${s}</option>`).join(""); editArea.value=get(editPos.value,editStk.value)||""; document.getElementById("editMeta").textContent=`(${editPos.value} √ó ${editStk.value})`; editModal.style.display="flex"; };
  document.getElementById("editClose").onclick=()=>editModal.style.display="none";
  editPos.addEventListener("change",()=>{editArea.value=get(editPos.value,editStk.value)||""; document.getElementById("editMeta").textContent=`(${editPos.value} √ó ${editStk.value})`;});
  editStk.addEventListener("change",()=>{editArea.value=get(editPos.value,editStk.value)||""; document.getElementById("editMeta").textContent=`(${editPos.value} √ó ${editStk.value})`;});
  document.getElementById("editSave").onclick=()=>{ set(editPos.value,editStk.value,editArea.value); editModal.style.display="none"; };
  document.getElementById("editClear").onclick=()=>{ if(confirm("–î–∞ –∏–∑—á–∏—Å—Ç—è —Ç–∞–∑–∏ –∫–ª–µ—Ç–∫–∞?")){ set(editPos.value,editStk.value,""); editModal.style.display="none"; } };

  /* ================= Controls ================= */
  document.getElementById("btnStart").onclick=()=>{count=right=streak=0; document.getElementById("qCount").textContent=0; document.getElementById("qRight").textContent=0; document.getElementById("streak").textContent=0; askNew(); };
  document.getElementById("btnResetScore").onclick=()=>{count=right=streak=0; document.getElementById("qCount").textContent=0; document.getElementById("qRight").textContent=0; document.getElementById("streak").textContent=0; document.getElementById("jokerPanel").style.display="none"; document.getElementById("feedback").textContent=""; document.getElementById("correctRow").style.display="none";};
  document.getElementById("btnNext").onclick=()=>askNew();
  document.getElementById("btnCheck").onclick=()=>checkAnswer(false);

  document.getElementById("toggleSettings").onclick=()=>{
    const s=document.getElementById("settingsCard");
    s.style.display = (s.style.display==="none"||!s.style.display) ? "block" : "none";
  };

  /* ================= Init ================= */
  function rand(arr){return arr[Math.floor(Math.random()*arr.length)];}
  document.getElementById("jokerPanel").style.display="none"; document.getElementById("jokerModeName").textContent=labelForMode(jokerMode);
  curQ={pos:"HUSB", stk:"10‚Äì13", hand:"AJs"};
  document.getElementById("qPos").textContent="–ü–æ–∑–∏—Ü–∏—è: "+curQ.pos;
  document.getElementById("qStack").textContent="–°—Ç–∞–∫: "+curQ.stk;
  document.getElementById("qHand").textContent=curQ.hand;
  renderAnswerUI(); renderHeroPNG(curQ.hand); animateHeroCards();
})();
</script>
</body>
</html>
